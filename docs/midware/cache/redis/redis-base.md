# Redis基础

## 基础相关概念

### Redis相关数据结构

redis中经常被使用到的数据结构包含String、List、ZSet、Hash、Set

扩展数据结构包含HyperLogLogs、Bitmap、Geospatial

### Redis String相关
String无论是在redis中还是在日常开发中都是作为最常用的数据结构，java实现的String底层使用的是byte数组，而redis实现的SDS底层使用的其实也还是char数组，但是额外增加了很多内容。

#### Redis String的实现SDS

redis使用C语言进行编码，在C语言中表示字符串可以使用 char* 来表示。但是 char* 存在一些弊端。

- 获取长度时需要进行遍历，此外还需要手动检查和分配字符串空间，在操作字符串追加时比较复杂
- 使用字符”\0“进行字符串结束标识，导致正常字符串若是出现结束标识符会被截断

于是redis设计了SDS（简单动态字符串）数据结构，包含字符数组长度、字符数组分配的空间长度、字符串类型、字符数组。
所以SDS本质还是字符数组，但是额外增加了三大元数据。三大元数据带来了很多操作效率上的提升：

- 可以直接获取数据长度而不需要再去遍历字符数组来获取
- 同时由于redis采用预分配原则，在记录了分配的空间长度的同时进行字符串追加的时候若是判断在申请空间范围内，不需要再申请空间，效率提升。

此外redis对于内存的使用十分极致，仅仅是为了能够灵活的保存不同大小的字符串，避免统一规格导致小字符串结构体元数据占用多一丁点的内存，SDS就设计有四大类型（排除不适用的sdshdr5）：

- sdshdr8
  - 其len和alloc元数据的数据类型使用uint8_t，能表示不超过2的8次方也就是256，因此在此类型下字符串最大长度不超过256字节。
- sdshdr16
  - 其len和alloc元数据的数据类型使用uint16_t，能表示不超过2的16次方。
- sdshdr32
  - 其len和alloc元数据的数据类型使用uint32_t，能表示不超过2的32次方。
- sdshdr64
  - 其len和alloc元数据的数据类型使用uint64_t，能表示不超过2的64次方。

更为极致的内存空间优化redis甚至在编译sdshdr8结构时使用 ”__ attribute__ ((__ packed__))“，不进行内存对齐，也就是哪怕这个变量不足8字节，在内存对齐情况下也会给你分配8字节内存。而reids则采用紧凑型方式分配，结构体多大就分配多大内存。

### Redis Hash相关
Hash表也是常用的数据结构之一，O(1)复杂度的快速查找，和Java的Hash表类似，redis的Hash表也需要处理Hash冲突和扩容问题。

#### Redis Hash冲突解决方案
所谓Hash冲突就是不同的key定位到同一个Hash桶上，一般而言Hash冲突有两种解决方式，一种是拉链法，一种是开放地址法。

开放地址法：当key定位到Hash表同一个桶位置时则顺着表找到空桶给放进去，在java中ThreadLocalMap就是使用开发地址法解决冲突。

拉链法：冲突时拉起一个链表，挨个放到链表里去。java中的HashMap和redis中的hash表都是使用这种方式，但是java的HashMap还有链表转红黑树的优化。

#### Redis Hash表扩容rehash
